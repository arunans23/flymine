#!/bin/bash

if test -d $HOME/tmp ; then
	TMP_DIR=$HOME/tmp
else
	TMP_DIR=/tmp
fi

FILENAME="stdin"
EPS_FILENAME=${TMP_DIR}/`hexdump </dev/urandom | head -n 1 | tr -d " "`".eps"
DELETE_AFTER=False
RES_SET=False
ANT_SET=False
SZX_SET=False
SZY_SET=False
ALPHA=False

while test $# -gt 0 ; do
	case $1 in
	    -r)
		if test $# -gt 1 ; then
			RES=$2
			RES_SET=True
			shift
			#echo "Resolution set to $RES" 1>&2
		else
			echo "-r needs an option" 1>&2
			exit
		fi
		;;
	    -a)
		if test $# -gt 1 ; then
			ANTIALIAS=$2
			ANT_SET=True
			shift
			#echo "Antialiasing set to $ANTIALIAS" 1>&2
		else
			echo "-a needs an option" 1>&2
			exit
		fi
		;;
	    -x)
		if test $# -gt 1 ; then
			SZX=$2
			SZX_SET=True
			shift
			#echo "X-Size set to $SZX" 1>&2
		else
			echo "-x needs an option" 1>&2
			exit
		fi
		;;
	    -y)
		if test $# -gt 1 ; then
			SZY=$2
			SZY_SET=True
			shift
			#echo "Y-Size set to $SZY" 1>&2
		else
			echo "-y needs an option" 1>&2
			exit
		fi
		;;
	    -A)
		ALPHA=True
		;;
	    *)
		FILENAME=$1
		;;
	esac
	shift
done

if test "$FILENAME" = "stdin" ; then
	FILENAME=${TMP_DIR}/`hexdump </dev/urandom | head -n 1 | tr -d " "`
	DELETE_AFTER=True
	TODELETE=$FILENAME
	cat >$FILENAME
fi

#echo "-n -e $EPS_FILENAME $FILENAME" 1>&2
dia -n -e $EPS_FILENAME $FILENAME >/dev/null 2>&1

if ! test -f "$EPS_FILENAME" ; then
    echo "Dia failed to produce output - do you have access to X?" 1>&2
    exit
fi

COMMAND_LINE=$EPS_FILENAME

if test "True" = "$RES_SET" ; then
	COMMAND_LINE="$COMMAND_LINE -r $RES"
fi
if test "True" = "$ANT_SET" ; then
	COMMAND_LINE="$COMMAND_LINE -a $ANTIALIAS"
fi
if test "True" = "$SZX_SET" ; then
	COMMAND_LINE="$COMMAND_LINE -x $SZX"
fi
if test "True" = "$SZY_SET" ; then
	COMMAND_LINE="$COMMAND_LINE -y $SZY"
fi
if test "True" = "$ALPHA" ; then
	COMMAND_LINE="$COMMAND_LINE -A"
fi

pstopng $COMMAND_LINE

rm $EPS_FILENAME

if test "$DELETE_AFTER" = "True" ; then
	rm $TODELETE
fi

