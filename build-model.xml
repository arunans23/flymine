<project name="FlyMine model" default="all" basedir=".">
  <description>FlyMine model build file</description>

  <!--
  The following properties are used in this file:

  model.name: the name of the model
  model.src: the source location for the model
  class.path: the classpath to use
  db.name: the name of the database to build, if actually building the schema
  build.model: the location of the model build directory
  build.tmp: the location to store temporary files
  resources: the location of any static resource files
  -->

  <!-- Create the directory that this model will be built to -->
  <target name="prepare"
          description="Create a directory that this model will be built to">
    <mkdir dir="${build.model}/${model.name}" />
  </target>


  <!-- has .zargo been unzipped? -->
  <target name="unpack-xmi-model.check" depends="prepare">
    <uptodate property="unpack-xmi-model.uptodate">
      <srcfiles dir="${model.src}" includes="${model.name}.zargo" />
      <mapper type="glob" from="*.zargo" to="${build.tmp}/*_.xmi" />
    </uptodate>
  </target>
  
  <!-- unzip .zargo file -->
  <target name="unpack-xmi-model" depends="unpack-xmi-model.check"
          description="unpacks an XMI model from .zargo file"
          unless="unpack-xmi-model.uptodate">
    <unzip src="${model.src}/${model.name}.zargo" dest="${build.tmp}">
      <patternset>
        <include name="${model.name}_.xmi"/>
      </patternset>
    </unzip>

    <touch file="${build.tmp}/${model.name}_.xmi" />
  </target>


  <!-- copy an exiting xmi file to build/tmp -->
  <target name="copy-xmi" depends="prepare">
    <copy file="${model.src}/${model.name}.xmi" tofile="${build.tmp}/${model.name}_.xmi"/>
  </target>


  <!-- copy flymine xml model file to build model directory -->
  <target name="copy-xml-model" depends="prepare">
    <copy todir="${build.model}/${model.name}" file="${model.src}/${model.name}_model.xml"/>
  </target>

  <!-- copy key definition files -->
  <target name="copy-keydefs" depends="prepare">
    <copy todir="${build.model}/${model.name}">
      <fileset dir="${model}/${model.name}/resources">
        <include name="*.properties"/>
      </fileset>
    </copy>
  </target>


  <!-- Model generation targets -->
  <target name="generate-xmi-model"
          description="Generate FlyMine model from an XMI file">
    <taskdef name="model-generation" classname="org.flymine.modelproduction.ModelGenerationTask">
      <classpath refid="class.path"/>
    </taskdef>

    <!-- if from ArgoUML the XMI filename will have a trailing underscore -->


    <model-generation
      type="xmi"
      modelname="${model.name}"
      source="${build.tmp}/${model.name}_.xmi"
      destdir="${build.model}/${model.name}" />   
  </target>


  <target name="generate-acedb-model" depends="prepare"
          description="Generate a FlyMine model file from an AceDB model file">
    <taskdef
      name="model-generation"
      classname="org.flymine.modelproduction.ModelGenerationTask">
      <classpath refid="class.path"/>
    </taskdef>

    <model-generation
      type="acedb"
      modelname="${model.name}"
      source="${model.src}/${model.name}.wrm"
      destdir="${build.model}/${model.name}"/>
  </target>


  <!-- Code generation targets -->

  <target name="generate-java" depends="prepare"
          description="Generate Java files from a FlyMine model file">
    <taskdef name="model-output" classname="org.flymine.codegen.ModelOutputTask">
      <classpath refid="class.path" />
    </taskdef>

    <model-output type="java" model="${model.name}" destdir="${build.model}/${model.name}"/>
  </target>

  <target name="generate-torque"
          description="Generate Torque schema description from a FlyMine model file">
    <taskdef name="model-output" classname="org.flymine.codegen.ModelOutputTask">
      <classpath refid="class.path" />
    </taskdef>

    <model-output type="flyminetorque" model="${model.name}" destdir="${build.model}/${model.name}"/>
  </target>

  <!-- compile java source -->
  <target name="compile-java" depends="generate-java">
    <javac destdir="${build.model}/${model.name}" listfiles="yes">
      <classpath refid="class.path"/>
      <src path="${build.model}/${model.name}" />
    </javac>
  </target>

  <target name="build-db" depends="generate-torque"
          description="Build database tables from a Torque description">
    <taskdef
      name="build-db"
      classname="org.flymine.task.BuildDbTask">
      <classpath refid="class.path"/>
    </taskdef>
    
    <build-db
      database="${db.name}"
      destdir="${build.model}/${model.name}">
      <fileset dir="${build.model}/${model.name}">
        <include name="*-schema.xml" />
      </fileset>
    </build-db>
  </target>

  <!-- Targets that could be called from another build script -->
  <target name="build-model-from-xml" depends="copy-xml-model, compile-java, copy-keydefs"
          description="Build a usable model from a FlyMine model XML file">
  </target>

  <target name="build-model-from-zargo" depends="unpack-xmi-model, generate-xmi-model, compile-java, copy-keydefs"
          description="Build a usable model from a .zargo file">
  </target>

  <target name="generate-model-from-zargo" depends="unpack-xmi-model, generate-xmi-model, copy-keydefs"
          description="Generate a FlyMine xml model from a .zargo file">
  </target>

  <target name="build-model-from-xmi" depends="generate-xmi-model, compile-java, copy-keydefs"
          description="Build a usable model from a .zargo file">
  </target>

  <target name="generate-model-from-xmi" depends="copy-xmi, generate-xmi-model, copy-keydefs"
          description="Generate a FlyMine xml model from a xmi file">
  </target>
  

  <target name="build-model-from-ace" depends="generate-acedb-model, compile-java, copy-keydefs"
          description="Build a usable model from an AceDB .wrm file">
  </target>

  <target name="jar" depends="compile-java"
          description="create a jar of a model">
    <jar destfile="${dist}/flymine-${model.name}.jar">
      <fileset dir="${build.model}/${model.name}" >
        <exclude name="**/*.java"/>
      </fileset>
    </jar>
  </target>

  <!-- create indexes task definition -->
  <target name="create-indexes" depends="copy-keydefs">
    <taskdef
      name="create-indexes"
      classname="org.flymine.task.CreateIndexesTask">
      <classpath refid="class.path"/>
    </taskdef>

    <create-indexes database="${db.name}" model="${model.name}"/>
  </target>


  <target name="add-model-to-webapp" depends="prepare"
    description="Add a model to the webapp">

    <!-- model-specific files -->
    <loadfile property="model.struts.config" srcFile="${model}/${model.name}/resources/web/struts-config-model.xml"/>
    <replace file="${build.webapp}/flymine/WEB-INF/struts-config.xml" value="${model.struts.config}">
      <!-- can't use normal token as xml must be parseable before this replacement -->
      <replacetoken><![CDATA[<!--@MODEL_INCLUDE@-->]]></replacetoken>
    </replace>

    <copy todir="${build.webapp}/flymine/model">
      <fileset dir="${model}/${model.name}/src/web"/>
    </copy>

    <copy todir="${build.webapp}/flymine/WEB-INF">
       <fileset dir="${model}/${model.name}/resources/web"/>
    </copy>

    <copy todir="${build.webapp}/flymine/WEB-INF/classes">
       <fileset dir="${model}/${model.name}/resources/web" includes="model*.properties"/>
    </copy>

    <copy todir="${build.webapp}/flymine/WEB-INF/lib">
       <fileset dir="${dist}" includes="flymine-${model.name}.jar"/>
    </copy>

  </target>

</project>
